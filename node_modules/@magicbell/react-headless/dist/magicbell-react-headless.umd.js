!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react"),require("zustand/vanilla"),require("zustand"),require("humps"),require("axios"),require("immer"),require("ramda"),require("ably"),require("mitt"),require("dayjs"),require("dayjs/plugin/localizedFormat"),require("dayjs/plugin/relativeTime"),require("dayjs/plugin/updateLocale")):"function"==typeof define&&define.amd?define(["exports","react","zustand/vanilla","zustand","humps","axios","immer","ramda","ably","mitt","dayjs","dayjs/plugin/localizedFormat","dayjs/plugin/relativeTime","dayjs/plugin/updateLocale"],t):t((e||self).reactHeadless={},e.react,e.create,e.zustand,e.humps,e.axios,e.immer,e.ramda,e.ably,e.mitt,e.dayjs,e.localizedFormat,e.relativeTime,e.updateLocale)}(this,function(e,t,r,n,o,i,a,u,s,c,f,l,d,m){function h(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function v(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var p=/*#__PURE__*/h(t),A=/*#__PURE__*/h(r),g=/*#__PURE__*/h(n),y=/*#__PURE__*/h(o),P=/*#__PURE__*/h(i),S=/*#__PURE__*/h(a),E=/*#__PURE__*/v(s),O=/*#__PURE__*/h(c),x=/*#__PURE__*/h(f),R=/*#__PURE__*/h(l),b=/*#__PURE__*/h(d),k=/*#__PURE__*/h(m);function U(){return(U=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function w(e,t){return(w=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function j(e,t){if(null==e)return{};var r,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)t.indexOf(r=i[n])>=0||(o[r]=e[r]);return o}var C=A.default(function(){return{apiKey:"",apiSecret:void 0,userEmail:void 0,userExternalId:void 0,userKey:void 0,clientId:Math.random().toString(36).substring(2)+Date.now(),serverURL:"https://api.magicbell.com"}}),I="__MAGICBELL_HOOKS__",L="undefined"==typeof window?global:window,N={get:function(e,t){return L[I]&&L[I][e]?L[I][e]:t},set:function(e,t){L[I]=L[I]||{},L[I][e]=t}};function _(){var e=C.getState(),t=e.apiSecret,r=e.userEmail,n=e.userExternalId,o=e.userKey,i={"X-MAGICBELL-CLIENT-ID":e.clientId,"X-MAGICBELL-API-KEY":e.apiKey};return t&&(i["X-MAGICBELL-API-SECRET"]=t),r&&(i["X-MAGICBELL-USER-EMAIL"]=r),o&&(i["X-MAGICBELL-USER-HMAC"]=o),n&&(i["X-MAGICBELL-USER-EXTERNAL-ID"]=n),i}function M(e,t,r,n){var o=C.getState().serverURL,i=_();return N.get("axios",P.default)({method:e,url:t,data:r,params:n,headers:i,baseURL:o}).then(function(e){return e.data},function(e){throw e})}function q(e,t){return void 0===t&&(t={}),M("get",e,void 0,t)}function D(e,t,r){return void 0===t&&(t={}),void 0===r&&(r={}),M("post",e,t,r)}function z(e,t){return void 0===t&&(t={}),M("delete",e,void 0,t)}function F(e,t,r){return void 0===r&&(r={}),M("put",e,t,r)}var B=/*#__PURE__*/function(){function e(e){void 0===e&&(e="/config"),this.remotePathOrUrl=void 0,this.remotePathOrUrl=e}return e.prototype.get=function(){try{return Promise.resolve(q(this.remotePathOrUrl)).then(function(e){return y.default.camelizeKeys(e)})}catch(e){return Promise.reject(e)}},e}(),K=g.default(function(e,t){return{channels:void 0,inbox:void 0,ws:void 0,lastFetchedAt:void 0,_repository:new B,fetch:function(){try{var r=t();return Promise.resolve(r._repository.get()).then(function(t){e(U({},t,{lastFetchedAt:Date.now()}))})}catch(e){return Promise.reject(e)}}}}),T=/*#__PURE__*/function(e){var t,r;function n(t){return void 0===t&&(t="/notifications"),e.call(this,t)||this}r=e,(t=n).prototype=Object.create(r.prototype),t.prototype.constructor=t,w(t,r);var o=n.prototype;return o.markAsRead=function(e){return D(this.remotePathOrUrl+"/"+e+"/read").then(function(){return!0}).catch(function(){return!1})},o.markAsUnread=function(e){return D(this.remotePathOrUrl+"/"+e+"/unread").then(function(){return!0}).catch(function(){return!1})},o.markAllAsSeen=function(){return D(this.remotePathOrUrl+"/seen").then(function(){return!0}).catch(function(){return!1})},o.markAllAsRead=function(){return D(this.remotePathOrUrl+"/read").then(function(){return!0}).catch(function(){return!1})},n}(/*#__PURE__*/function(){function e(e){this.remotePathOrUrl=void 0,this.remotePathOrUrl=e}var t=e.prototype;return t.get=function(e){try{return Promise.resolve(q(this.remotePathOrUrl+"/"+e)).then(function(e){return y.default.camelizeKeys(e)})}catch(e){return Promise.reject(e)}},t.findBy=function(e){try{var t=this;return Promise.resolve(function(r,n){try{var o=Promise.resolve(q(t.remotePathOrUrl,e)).then(function(e){return y.default.camelizeKeys(e)})}catch(e){return n(e)}return o&&o.then?o.then(void 0,n):o}(0,function(e){if(!/Network Error/.test(e.message))throw e}))}catch(e){return Promise.reject(e)}},t.delete=function(e){return z(this.remotePathOrUrl+"/"+e).then(function(){return!0}).catch(function(){return!1})},e}()),G=O.default(),X=O.default();function H(e,t,r){"remote"===r&&G.emit(e,t),X.emit(e,{data:t,source:r})}function J(e){var t=C.getState().clientId,r=e.name.replace(/\//gi,"."),n=e.data;return n.client_id&&n.client_id===t?Promise.resolve(!1):"string"==typeof n.id?"notifications.delete"===r?(H(r,n,"remote"),Promise.resolve(!0)):(new T).get(n.id).then(function(e){return H(r,e.notification,"remote"),!0}):(H(r,n,"remote"),Promise.resolve(!0))}function Q(e){return u.mergeRight({context:{},total:0,totalPages:0,perPage:0,currentPage:1,unreadCount:0,unseenCount:0,notifications:[]},e)}var Y=["notifications"];function V(e,t){return e===t||e!=e&&t!=t}function W(e,t,r){void 0===r&&(r=V);var n=[];return Object.keys(t).forEach(function(o){var i,a=t[o];("read"===o&&!r(!u.isNil(e.readAt),a)||"seen"===o&&!r(!u.isNil(e.seenAt),a)||"categories"===o&&(i=a,Array.isArray(i)?i:[i]).some(function(t){return!r(e.category,t)})||Object.hasOwnProperty.call(e,o)&&!r(e[o],a))&&n.push(o)}),{result:0===n.length,delta:n}}var Z=g.default(function(e,t){return{stores:{},_repository:new T,setStore:function(t,r,n){void 0===r&&(r={}),void 0===n&&(n={}),e(S.default(function(e){e.stores[t]=Q(U({},n,{context:r}))}))},fetchStore:function(r,n,o){void 0===n&&(n={}),void 0===o&&(o={});try{var i=t(),a=i._repository,s=i.stores[r];return Promise.resolve(function(){if(s)return Promise.resolve(a.findBy(U({},s.context,n))).then(function(t){t&&e(S.default(function(e){e.stores[r]=function(e,t,r){void 0===r&&(r={reset:!1});var n=t.notifications,o=j(t,Y),i=r.reset?n:u.uniqBy(function(e){return e.id},r.prepend?[].concat(n,e.notifications):[].concat(e.notifications,n));return U({context:e.context,notifications:i},o)}(s,U({},t,{lastFetchedAt:new Date}),o)}))});console.error("Store not found. Define a store with the "+r+" ID")}())}catch(e){return Promise.reject(e)}},fetchAllStores:function(e,r){void 0===e&&(e={}),void 0===r&&(r={});try{var n=t(),o=n.fetchStore,i=Object.keys(n.stores).map(function(t){return o(t,e,r)});return Promise.resolve(Promise.all(i)).then(function(){})}catch(e){return Promise.reject(e)}},markNotificationAsSeen:function(r){var n=t().stores,o=r.id;H("notifications.seen",r,"local"),e(S.default(function(e){for(var t in n){var r=n[t],i=r.notifications,a=r.unseenCount,s=u.findIndex(u.propEq("id",o),i);s>-1&&(i[s].seenAt||(e.stores[t].unseenCount=Math.max(0,a-1),e.stores[t].notifications[s]=u.mergeRight(i[s],{seenAt:Date.now()/1e3})))}}))},markNotificationAsRead:function(r){var n=t(),o=n.stores,i=r.id,a=n._repository.markAsRead(i);return H("notifications.read",r,"local"),e(S.default(function(e){var t={readAt:Date.now()/1e3};for(var n in o){var a=o[n],s=a.total,c=a.notifications,f=a.unreadCount,l=a.context,d=u.findIndex(u.propEq("id",i),c);if(d>-1){e.stores[n].unreadCount=Math.max(0,f-1);var m=u.mergeRight(c[d],t);W(m,l).result?e.stores[n].notifications[d]=m:(e.stores[n].total=Math.max(0,s-1),e.stores[n].notifications.splice(d,1))}else{var h=u.mergeRight(r,t);W(h,l).result&&(e.stores[n].total+=1,e.stores[n].notifications.push(h))}}})),a},markNotificationAsUnread:function(r){var n=t(),o=n.stores,i=r.id,a=n._repository.markAsUnread(i);return H("notifications.unread",r,"local"),e(S.default(function(e){var t={readAt:null};for(var n in o){var a=o[n],s=a.total,c=a.notifications,f=a.context,l=u.findIndex(u.propEq("id",i),c);if(l>-1){var d=u.mergeRight(c[l],t);W(d,f).result?(e.stores[n].unreadCount+=1,e.stores[n].notifications[l]=d):(e.stores[n].total-=Math.max(0,s-1),e.stores[n].notifications.splice(l,1))}else{var m=u.mergeRight(r,t);W(m,f).result&&(e.stores[n].total+=1,e.stores[n].unreadCount+=1,e.stores[n].notifications.push(m))}}})),a},deleteNotification:function(r,n){void 0===n&&(n={});var o=t(),i=o.stores,a=o._repository,s=r.id,c=Promise.resolve(!0);return!1!==n.persist&&(c=a.delete(s),H("notifications.delete",r,"local")),e(S.default(function(e){for(var t in i){var r=i[t],n=r.notifications,o=r.total,a=r.unseenCount,c=r.unreadCount,f=u.findIndex(u.propEq("id",s),n);if(f>-1){var l=n[f];l.seenAt||(e.stores[t].unseenCount=Math.max(0,a-1)),l.readAt||(e.stores[t].unreadCount=Math.max(0,c-1)),e.stores[t].total=Math.max(0,o-1),e.stores[t].notifications.splice(f,1)}}})),c},markAllAsSeen:function(r){void 0===r&&(r={persist:!0,updateModels:!0});var n=t(),o=n.stores,i=n._repository,a=Promise.resolve(!0);return!1!==r.persist&&(a=i.markAllAsSeen(),H("notifications.seen.all",null,"local")),e(S.default(function(e){var t=function(t){var n=o[t].notifications;e.stores[t].unseenCount=0,!1!==r.updateModels&&n.forEach(function(r,n){e.stores[t].notifications[n]=u.mergeRight(r,{seenAt:Date.now()/1e3})})};for(var n in o)t(n)})),a},markAllAsRead:function(r){void 0===r&&(r={persist:!0,updateModels:!0});var n=t(),o=n.stores,i=n._repository,a=Promise.resolve(!0);return!1!==r.persist&&(a=i.markAllAsRead(),H("notifications.read.all",null,"local")),e(S.default(function(e){var t=function(t){var n=o[t].notifications;e.stores[t].unreadCount=0,!1!==r.updateModels&&n.forEach(function(r,n){e.stores[t].notifications[n]=u.mergeRight(r,{readAt:Date.now()/1e3})})};for(var n in o)t(n)})),a}}});function $(e,r,n){void 0===n&&(n={source:"any"}),t.useEffect(function(){var t=function(e){void 0===e&&(e={}),"remote"===n.source&&"remote"!==e.source||"local"===n.source&&"local"!==e.source||r(e.data,e.source)};return X.on(e,t),function(){X.off(e,t)}},[])}function ee(){var e,r=Z(),n=function(){return r.fetchAllStores({page:1},{reset:!0})};return e=K(),t.useEffect(function(){return e.ws?function(e){var t=e.channel,r=function(e){var t=C.getState().serverURL+"/"+e.authUrl,r=_();return new E.Realtime({authUrl:t,authHeaders:r,authMethod:"POST",log:{level:0},transports:["web_socket"]})}(e),n=function(){return H("wakeup",null,"local")};r.connection.on("disconnected",n),r.connection.on("suspended",n);var o=r.channels.get(t);return o.subscribe(J),function(){o.unsubscribe(J),o.detach(),r.connection.off("disconnected"),r.connection.off("suspended"),r.close()}}(e.ws):function(){}},[e.ws]),$("wakeup",n),$("notifications.new",function(){return r.fetchAllStores({page:1},{prepend:!0})},{source:"remote"}),$("notifications.seen.all",function(){return r.markAllAsSeen({persist:!1})},{source:"remote"}),$("notifications.read.all",function(){return r.markAllAsRead({persist:!1})},{source:"remote"}),$("notifications.read",n,{source:"remote"}),$("notifications.unread",n,{source:"remote"}),$("notifications.delete",function(e){return r.deleteNotification(e,{persist:!1})},{source:"remote"}),null}var te=["serverURL"],re=["children","stores","disableRealtime"];function ne(e){var t=e.serverURL,r=j(e,te);return t&&(r.serverURL=t),C.setState(r),r}function oe(e){void 0===e&&(e="default");var r=Z(),n=r.stores,o=r.fetchStore,i=r.markAllAsSeen,a=r.markAllAsRead,u=K(),s=n[e],c=function(t,r){return o(e,t,r)};return t.useEffect(function(){s&&u.lastFetchedAt&&!s.lastFetchedAt&&c({page:1})},[u.lastFetchedAt]),s?U({},s,{isEmpty:0===s.notifications.length,hasNextPage:s.currentPage<s.totalPages,fetch:c,fetchNextPage:function(t,r){return void 0===t&&(t={}),o(e,U({},t,{page:s.currentPage+1}),r)},markAllAsSeen:i,markAllAsRead:a}):null}function ie(e){return e?ae(1e3*e):null}function ae(e){return x.default(e)}function ue(e){if(u.isNil(e))return null;if("string"==typeof e)try{return JSON.parse(e)}catch(e){console.warn('"customAttributes" is not valid JSON')}return e}function se(e){var t=Z(),r=t.markNotificationAsRead,n=t.markNotificationAsSeen,o=t.markNotificationAsUnread,i=t.deleteNotification;return U({},e,{customAttributes:ue(e.customAttributes),readAt:ie(e.readAt),seenAt:ie(e.seenAt),sentAt:ie(e.sentAt),archivedAt:ie(e.archivedAt),isSeen:!u.isNil(e.seenAt),isRead:!u.isNil(e.readAt),isArchived:!u.isNil(e.archivedAt),sanitizedContent:e.content,markAsSeen:function(){return n(e)},markAsRead:function(){return r(e)},markAsUnread:function(){return o(e)},delete:function(){return i(e)}})}function ce(e,r){t.useEffect(function(){return function(){r?r(e):e.markAsSeen()}},[])}x.default.extend(R.default),x.default.extend(b.default),x.default.extend(k.default);var fe=/*#__PURE__*/function(){function e(e){void 0===e&&(e="/notification_preferences"),this.remotePathOrUrl=void 0,this.remotePathOrUrl=e}var t=e.prototype;return t.get=function(){try{return Promise.resolve(q(this.remotePathOrUrl)).then(function(e){return y.default.camelizeKeys(e)})}catch(e){return Promise.reject(e)}},t.update=function(e){return F(this.remotePathOrUrl,y.default.decamelizeKeys(e)).then(function(){return!0}).catch(function(){return!1})},e}(),le=g.default(function(e,t){return{categories:{},_repository:new fe,fetch:function(){try{var r=t();return Promise.resolve(r._repository.get()).then(function(t){e(U({},t.notificationPreferences,{lastFetchedAt:Date.now()}))})}catch(e){return Promise.reject(e)}},save:function(r){try{var n=t(),o=n.categories;return n._repository.update({notificationPreferences:r}),e({categories:u.mergeDeepRight(o,r.categories),lastFetchedAt:Date.now()}),Promise.resolve()}catch(e){return Promise.reject(e)}}}});e.MagicBellProvider=function(e){var r=e.children,n=e.stores,o=void 0===n?[{id:"default",defaultQueryParams:{}}]:n,i=e.disableRealtime,a=j(e,re);t.useState(function(){return ne(a)}),t.useState(function(){return function(e){var t={};return e.forEach(function(e){var r=e.defaults;t[e.id]=Q(U({context:e.defaultQueryParams},void 0===r?{}:r))}),Z.setState({stores:t}),t}(o)});var u=K();return t.useEffect(function(){u.lastFetchedAt||u.fetch()},[u]),p.default.createElement(p.default.Fragment,null,i?null:p.default.createElement(ee,null),r)},e.RealtimeListener=ee,e.buildStore=Q,e.clientSettings=C,e.deleteAPI=z,e.eventAggregator=X,e.fetchAPI=q,e.postAPI=D,e.pushEventAggregator=G,e.putAPI=F,e.registry=N,e.secondsToDate=ie,e.toDate=ae,e.toUnix=function(e){return x.default(e).unix()},e.useBell=function(e){var t=oe((void 0===e?{}:e).storeId);return t?U({},t,{markAllAsSeen:function(){return t&&t.unseenCount>0?null==t?void 0:t.markAllAsSeen({updateModels:!1}):Promise.resolve(!0)}}):null},e.useConfig=K,e.useMagicBellEvent=$,e.useNotification=function(e,t){var r=se(e);return ce(r,t),r},e.useNotificationFactory=se,e.useNotificationPreferences=le,e.useNotificationStoresCollection=Z,e.useNotificationUnmount=ce,e.useNotifications=oe});
//# sourceMappingURL=magicbell-react-headless.umd.js.map
