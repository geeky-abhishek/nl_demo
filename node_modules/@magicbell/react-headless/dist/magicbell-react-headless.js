var e=require("react"),t=require("zustand/vanilla"),r=require("zustand"),n=require("humps"),o=require("axios"),i=require("immer"),a=require("ramda"),s=require("ably"),u=require("mitt"),c=require("dayjs"),f=require("dayjs/plugin/localizedFormat"),l=require("dayjs/plugin/relativeTime"),d=require("dayjs/plugin/updateLocale");function v(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function h(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var m=/*#__PURE__*/v(e),p=/*#__PURE__*/v(t),A=/*#__PURE__*/v(r),g=/*#__PURE__*/v(n),y=/*#__PURE__*/v(o),P=/*#__PURE__*/v(i),x=/*#__PURE__*/h(s),S=/*#__PURE__*/v(u),E=/*#__PURE__*/v(c),O=/*#__PURE__*/v(f),R=/*#__PURE__*/v(l),k=/*#__PURE__*/v(d);function U(){return(U=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function w(e,t){return(w=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function b(e,t){if(null==e)return{};var r,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)t.indexOf(r=i[n])>=0||(o[r]=e[r]);return o}var C=p.default(function(){return{apiKey:"",apiSecret:void 0,userEmail:void 0,userExternalId:void 0,userKey:void 0,clientId:Math.random().toString(36).substring(2)+Date.now(),serverURL:"https://api.magicbell.com"}}),I="__MAGICBELL_HOOKS__",N="undefined"==typeof window?global:window,_={get:function(e,t){return N[I]&&N[I][e]?N[I][e]:t},set:function(e,t){N[I]=N[I]||{},N[I][e]=t}};function j(){var e=C.getState(),t=e.apiSecret,r=e.userEmail,n=e.userExternalId,o=e.userKey,i={"X-MAGICBELL-CLIENT-ID":e.clientId,"X-MAGICBELL-API-KEY":e.apiKey};return t&&(i["X-MAGICBELL-API-SECRET"]=t),r&&(i["X-MAGICBELL-USER-EMAIL"]=r),o&&(i["X-MAGICBELL-USER-HMAC"]=o),n&&(i["X-MAGICBELL-USER-EXTERNAL-ID"]=n),i}function L(e,t,r,n){var o=C.getState().serverURL,i=j();return _.get("axios",y.default)({method:e,url:t,data:r,params:n,headers:i,baseURL:o}).then(function(e){return e.data},function(e){throw e})}function M(e,t){return void 0===t&&(t={}),L("get",e,void 0,t)}function q(e,t,r){return void 0===t&&(t={}),void 0===r&&(r={}),L("post",e,t,r)}function D(e,t){return void 0===t&&(t={}),L("delete",e,void 0,t)}function B(e,t,r){return void 0===r&&(r={}),L("put",e,t,r)}var F=/*#__PURE__*/function(){function e(e){void 0===e&&(e="/config"),this.remotePathOrUrl=void 0,this.remotePathOrUrl=e}return e.prototype.get=function(){try{return Promise.resolve(M(this.remotePathOrUrl)).then(function(e){return g.default.camelizeKeys(e)})}catch(e){return Promise.reject(e)}},e}(),K=A.default(function(e,t){return{channels:void 0,inbox:void 0,ws:void 0,lastFetchedAt:void 0,_repository:new F,fetch:function(){try{var r=t();return Promise.resolve(r._repository.get()).then(function(t){e(U({},t,{lastFetchedAt:Date.now()}))})}catch(e){return Promise.reject(e)}}}}),z=/*#__PURE__*/function(e){var t,r;function n(t){return void 0===t&&(t="/notifications"),e.call(this,t)||this}r=e,(t=n).prototype=Object.create(r.prototype),t.prototype.constructor=t,w(t,r);var o=n.prototype;return o.markAsRead=function(e){return q(this.remotePathOrUrl+"/"+e+"/read").then(function(){return!0}).catch(function(){return!1})},o.markAsUnread=function(e){return q(this.remotePathOrUrl+"/"+e+"/unread").then(function(){return!0}).catch(function(){return!1})},o.markAllAsSeen=function(){return q(this.remotePathOrUrl+"/seen").then(function(){return!0}).catch(function(){return!1})},o.markAllAsRead=function(){return q(this.remotePathOrUrl+"/read").then(function(){return!0}).catch(function(){return!1})},n}(/*#__PURE__*/function(){function e(e){this.remotePathOrUrl=void 0,this.remotePathOrUrl=e}var t=e.prototype;return t.get=function(e){try{return Promise.resolve(M(this.remotePathOrUrl+"/"+e)).then(function(e){return g.default.camelizeKeys(e)})}catch(e){return Promise.reject(e)}},t.findBy=function(e){try{var t=this;return Promise.resolve(function(r,n){try{var o=Promise.resolve(M(t.remotePathOrUrl,e)).then(function(e){return g.default.camelizeKeys(e)})}catch(e){return n(e)}return o&&o.then?o.then(void 0,n):o}(0,function(e){if(!/Network Error/.test(e.message))throw e}))}catch(e){return Promise.reject(e)}},t.delete=function(e){return D(this.remotePathOrUrl+"/"+e).then(function(){return!0}).catch(function(){return!1})},e}()),G=S.default(),X=S.default();function T(e,t,r){"remote"===r&&G.emit(e,t),X.emit(e,{data:t,source:r})}function H(e){var t=C.getState().clientId,r=e.name.replace(/\//gi,"."),n=e.data;return n.client_id&&n.client_id===t?Promise.resolve(!1):"string"==typeof n.id?"notifications.delete"===r?(T(r,n,"remote"),Promise.resolve(!0)):(new z).get(n.id).then(function(e){return T(r,e.notification,"remote"),!0}):(T(r,n,"remote"),Promise.resolve(!0))}function J(e){return a.mergeRight({context:{},total:0,totalPages:0,perPage:0,currentPage:1,unreadCount:0,unseenCount:0,notifications:[]},e)}var Q=["notifications"];function Y(e,t){return e===t||e!=e&&t!=t}function V(e,t,r){void 0===r&&(r=Y);var n=[];return Object.keys(t).forEach(function(o){var i,s=t[o];("read"===o&&!r(!a.isNil(e.readAt),s)||"seen"===o&&!r(!a.isNil(e.seenAt),s)||"categories"===o&&(i=s,Array.isArray(i)?i:[i]).some(function(t){return!r(e.category,t)})||Object.hasOwnProperty.call(e,o)&&!r(e[o],s))&&n.push(o)}),{result:0===n.length,delta:n}}var W=A.default(function(e,t){return{stores:{},_repository:new z,setStore:function(t,r,n){void 0===r&&(r={}),void 0===n&&(n={}),e(P.default(function(e){e.stores[t]=J(U({},n,{context:r}))}))},fetchStore:function(r,n,o){void 0===n&&(n={}),void 0===o&&(o={});try{var i=t(),s=i._repository,u=i.stores[r];return Promise.resolve(function(){if(u)return Promise.resolve(s.findBy(U({},u.context,n))).then(function(t){t&&e(P.default(function(e){e.stores[r]=function(e,t,r){void 0===r&&(r={reset:!1});var n=t.notifications,o=b(t,Q),i=r.reset?n:a.uniqBy(function(e){return e.id},r.prepend?[].concat(n,e.notifications):[].concat(e.notifications,n));return U({context:e.context,notifications:i},o)}(u,U({},t,{lastFetchedAt:new Date}),o)}))});console.error("Store not found. Define a store with the "+r+" ID")}())}catch(e){return Promise.reject(e)}},fetchAllStores:function(e,r){void 0===e&&(e={}),void 0===r&&(r={});try{var n=t(),o=n.fetchStore,i=Object.keys(n.stores).map(function(t){return o(t,e,r)});return Promise.resolve(Promise.all(i)).then(function(){})}catch(e){return Promise.reject(e)}},markNotificationAsSeen:function(r){var n=t().stores,o=r.id;T("notifications.seen",r,"local"),e(P.default(function(e){for(var t in n){var r=n[t],i=r.notifications,s=r.unseenCount,u=a.findIndex(a.propEq("id",o),i);u>-1&&(i[u].seenAt||(e.stores[t].unseenCount=Math.max(0,s-1),e.stores[t].notifications[u]=a.mergeRight(i[u],{seenAt:Date.now()/1e3})))}}))},markNotificationAsRead:function(r){var n=t(),o=n.stores,i=r.id,s=n._repository.markAsRead(i);return T("notifications.read",r,"local"),e(P.default(function(e){var t={readAt:Date.now()/1e3};for(var n in o){var s=o[n],u=s.total,c=s.notifications,f=s.unreadCount,l=s.context,d=a.findIndex(a.propEq("id",i),c);if(d>-1){e.stores[n].unreadCount=Math.max(0,f-1);var v=a.mergeRight(c[d],t);V(v,l).result?e.stores[n].notifications[d]=v:(e.stores[n].total=Math.max(0,u-1),e.stores[n].notifications.splice(d,1))}else{var h=a.mergeRight(r,t);V(h,l).result&&(e.stores[n].total+=1,e.stores[n].notifications.push(h))}}})),s},markNotificationAsUnread:function(r){var n=t(),o=n.stores,i=r.id,s=n._repository.markAsUnread(i);return T("notifications.unread",r,"local"),e(P.default(function(e){var t={readAt:null};for(var n in o){var s=o[n],u=s.total,c=s.notifications,f=s.context,l=a.findIndex(a.propEq("id",i),c);if(l>-1){var d=a.mergeRight(c[l],t);V(d,f).result?(e.stores[n].unreadCount+=1,e.stores[n].notifications[l]=d):(e.stores[n].total-=Math.max(0,u-1),e.stores[n].notifications.splice(l,1))}else{var v=a.mergeRight(r,t);V(v,f).result&&(e.stores[n].total+=1,e.stores[n].unreadCount+=1,e.stores[n].notifications.push(v))}}})),s},deleteNotification:function(r,n){void 0===n&&(n={});var o=t(),i=o.stores,s=o._repository,u=r.id,c=Promise.resolve(!0);return!1!==n.persist&&(c=s.delete(u),T("notifications.delete",r,"local")),e(P.default(function(e){for(var t in i){var r=i[t],n=r.notifications,o=r.total,s=r.unseenCount,c=r.unreadCount,f=a.findIndex(a.propEq("id",u),n);if(f>-1){var l=n[f];l.seenAt||(e.stores[t].unseenCount=Math.max(0,s-1)),l.readAt||(e.stores[t].unreadCount=Math.max(0,c-1)),e.stores[t].total=Math.max(0,o-1),e.stores[t].notifications.splice(f,1)}}})),c},markAllAsSeen:function(r){void 0===r&&(r={persist:!0,updateModels:!0});var n=t(),o=n.stores,i=n._repository,s=Promise.resolve(!0);return!1!==r.persist&&(s=i.markAllAsSeen(),T("notifications.seen.all",null,"local")),e(P.default(function(e){var t=function(t){var n=o[t].notifications;e.stores[t].unseenCount=0,!1!==r.updateModels&&n.forEach(function(r,n){e.stores[t].notifications[n]=a.mergeRight(r,{seenAt:Date.now()/1e3})})};for(var n in o)t(n)})),s},markAllAsRead:function(r){void 0===r&&(r={persist:!0,updateModels:!0});var n=t(),o=n.stores,i=n._repository,s=Promise.resolve(!0);return!1!==r.persist&&(s=i.markAllAsRead(),T("notifications.read.all",null,"local")),e(P.default(function(e){var t=function(t){var n=o[t].notifications;e.stores[t].unreadCount=0,!1!==r.updateModels&&n.forEach(function(r,n){e.stores[t].notifications[n]=a.mergeRight(r,{readAt:Date.now()/1e3})})};for(var n in o)t(n)})),s}}});function Z(t,r,n){void 0===n&&(n={source:"any"}),e.useEffect(function(){var e=function(e){void 0===e&&(e={}),"remote"===n.source&&"remote"!==e.source||"local"===n.source&&"local"!==e.source||r(e.data,e.source)};return X.on(t,e),function(){X.off(t,e)}},[])}function $(){var t,r=W(),n=function(){return r.fetchAllStores({page:1},{reset:!0})};return t=K(),e.useEffect(function(){return t.ws?function(e){var t=e.channel,r=function(e){var t=C.getState().serverURL+"/"+e.authUrl,r=j();return new x.Realtime({authUrl:t,authHeaders:r,authMethod:"POST",log:{level:0},transports:["web_socket"]})}(e),n=function(){return T("wakeup",null,"local")};r.connection.on("disconnected",n),r.connection.on("suspended",n);var o=r.channels.get(t);return o.subscribe(H),function(){o.unsubscribe(H),o.detach(),r.connection.off("disconnected"),r.connection.off("suspended"),r.close()}}(t.ws):function(){}},[t.ws]),Z("wakeup",n),Z("notifications.new",function(){return r.fetchAllStores({page:1},{prepend:!0})},{source:"remote"}),Z("notifications.seen.all",function(){return r.markAllAsSeen({persist:!1})},{source:"remote"}),Z("notifications.read.all",function(){return r.markAllAsRead({persist:!1})},{source:"remote"}),Z("notifications.read",n,{source:"remote"}),Z("notifications.unread",n,{source:"remote"}),Z("notifications.delete",function(e){return r.deleteNotification(e,{persist:!1})},{source:"remote"}),null}var ee=["serverURL"],te=["children","stores","disableRealtime"];function re(e){var t=e.serverURL,r=b(e,ee);return t&&(r.serverURL=t),C.setState(r),r}function ne(t){void 0===t&&(t="default");var r=W(),n=r.stores,o=r.fetchStore,i=r.markAllAsSeen,a=r.markAllAsRead,s=K(),u=n[t],c=function(e,r){return o(t,e,r)};return e.useEffect(function(){u&&s.lastFetchedAt&&!u.lastFetchedAt&&c({page:1})},[s.lastFetchedAt]),u?U({},u,{isEmpty:0===u.notifications.length,hasNextPage:u.currentPage<u.totalPages,fetch:c,fetchNextPage:function(e,r){return void 0===e&&(e={}),o(t,U({},e,{page:u.currentPage+1}),r)},markAllAsSeen:i,markAllAsRead:a}):null}function oe(e){return e?ie(1e3*e):null}function ie(e){return E.default(e)}function ae(e){if(a.isNil(e))return null;if("string"==typeof e)try{return JSON.parse(e)}catch(e){console.warn('"customAttributes" is not valid JSON')}return e}function se(e){var t=W(),r=t.markNotificationAsRead,n=t.markNotificationAsSeen,o=t.markNotificationAsUnread,i=t.deleteNotification;return U({},e,{customAttributes:ae(e.customAttributes),readAt:oe(e.readAt),seenAt:oe(e.seenAt),sentAt:oe(e.sentAt),archivedAt:oe(e.archivedAt),isSeen:!a.isNil(e.seenAt),isRead:!a.isNil(e.readAt),isArchived:!a.isNil(e.archivedAt),sanitizedContent:e.content,markAsSeen:function(){return n(e)},markAsRead:function(){return r(e)},markAsUnread:function(){return o(e)},delete:function(){return i(e)}})}function ue(t,r){e.useEffect(function(){return function(){r?r(t):t.markAsSeen()}},[])}E.default.extend(O.default),E.default.extend(R.default),E.default.extend(k.default);var ce=/*#__PURE__*/function(){function e(e){void 0===e&&(e="/notification_preferences"),this.remotePathOrUrl=void 0,this.remotePathOrUrl=e}var t=e.prototype;return t.get=function(){try{return Promise.resolve(M(this.remotePathOrUrl)).then(function(e){return g.default.camelizeKeys(e)})}catch(e){return Promise.reject(e)}},t.update=function(e){return B(this.remotePathOrUrl,g.default.decamelizeKeys(e)).then(function(){return!0}).catch(function(){return!1})},e}(),fe=A.default(function(e,t){return{categories:{},_repository:new ce,fetch:function(){try{var r=t();return Promise.resolve(r._repository.get()).then(function(t){e(U({},t.notificationPreferences,{lastFetchedAt:Date.now()}))})}catch(e){return Promise.reject(e)}},save:function(r){try{var n=t(),o=n.categories;return n._repository.update({notificationPreferences:r}),e({categories:a.mergeDeepRight(o,r.categories),lastFetchedAt:Date.now()}),Promise.resolve()}catch(e){return Promise.reject(e)}}}});exports.MagicBellProvider=function(t){var r=t.children,n=t.stores,o=void 0===n?[{id:"default",defaultQueryParams:{}}]:n,i=t.disableRealtime,a=b(t,te);e.useState(function(){return re(a)}),e.useState(function(){return function(e){var t={};return e.forEach(function(e){var r=e.defaults;t[e.id]=J(U({context:e.defaultQueryParams},void 0===r?{}:r))}),W.setState({stores:t}),t}(o)});var s=K();return e.useEffect(function(){s.lastFetchedAt||s.fetch()},[s]),m.default.createElement(m.default.Fragment,null,i?null:m.default.createElement($,null),r)},exports.RealtimeListener=$,exports.buildStore=J,exports.clientSettings=C,exports.deleteAPI=D,exports.eventAggregator=X,exports.fetchAPI=M,exports.postAPI=q,exports.pushEventAggregator=G,exports.putAPI=B,exports.registry=_,exports.secondsToDate=oe,exports.toDate=ie,exports.toUnix=function(e){return E.default(e).unix()},exports.useBell=function(e){var t=ne((void 0===e?{}:e).storeId);return t?U({},t,{markAllAsSeen:function(){return t&&t.unseenCount>0?null==t?void 0:t.markAllAsSeen({updateModels:!1}):Promise.resolve(!0)}}):null},exports.useConfig=K,exports.useMagicBellEvent=Z,exports.useNotification=function(e,t){var r=se(e);return ue(r,t),r},exports.useNotificationFactory=se,exports.useNotificationPreferences=fe,exports.useNotificationStoresCollection=W,exports.useNotificationUnmount=ue,exports.useNotifications=ne;
//# sourceMappingURL=magicbell-react-headless.js.map
