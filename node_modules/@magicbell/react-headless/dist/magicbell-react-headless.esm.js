import t,{useEffect as e,useState as r}from"react";import n from"zustand/vanilla";import o from"zustand";import i from"humps";import a from"axios";import s from"immer";import{mergeRight as u,uniqBy as c,isNil as f,findIndex as l,propEq as d,mergeDeepRight as m}from"ramda";import*as v from"ably";import h from"mitt";import p from"dayjs";import A from"dayjs/plugin/localizedFormat";import y from"dayjs/plugin/relativeTime";import P from"dayjs/plugin/updateLocale";function g(){return(g=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t}).apply(this,arguments)}function S(t,e){return(S=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function k(t,e){if(null==t)return{};var r,n,o={},i=Object.keys(t);for(n=0;n<i.length;n++)e.indexOf(r=i[n])>=0||(o[r]=t[r]);return o}var w=n(function(){return{apiKey:"",apiSecret:void 0,userEmail:void 0,userExternalId:void 0,userKey:void 0,clientId:Math.random().toString(36).substring(2)+Date.now(),serverURL:"https://api.magicbell.com"}}),O="__MAGICBELL_HOOKS__",U="undefined"==typeof window?global:window,E={get:function(t,e){return U[O]&&U[O][t]?U[O][t]:e},set:function(t,e){U[O]=U[O]||{},U[O][t]=e}};function x(){var t=w.getState(),e=t.apiSecret,r=t.userEmail,n=t.userExternalId,o=t.userKey,i={"X-MAGICBELL-CLIENT-ID":t.clientId,"X-MAGICBELL-API-KEY":t.apiKey};return e&&(i["X-MAGICBELL-API-SECRET"]=e),r&&(i["X-MAGICBELL-USER-EMAIL"]=r),o&&(i["X-MAGICBELL-USER-HMAC"]=o),n&&(i["X-MAGICBELL-USER-EXTERNAL-ID"]=n),i}function R(t,e,r,n){var o=w.getState().serverURL,i=x();return E.get("axios",a)({method:t,url:e,data:r,params:n,headers:i,baseURL:o}).then(function(t){return t.data},function(t){throw t})}function C(t,e){return void 0===e&&(e={}),R("get",t,void 0,e)}function L(t,e,r){return void 0===e&&(e={}),void 0===r&&(r={}),R("post",t,e,r)}function _(t,e){return void 0===e&&(e={}),R("delete",t,void 0,e)}function b(t,e,r){return void 0===r&&(r={}),R("put",t,e,r)}var M=/*#__PURE__*/function(){function t(t){void 0===t&&(t="/config"),this.remotePathOrUrl=void 0,this.remotePathOrUrl=t}return t.prototype.get=function(){try{return Promise.resolve(C(this.remotePathOrUrl)).then(function(t){return i.camelizeKeys(t)})}catch(t){return Promise.reject(t)}},t}(),j=o(function(t,e){return{channels:void 0,inbox:void 0,ws:void 0,lastFetchedAt:void 0,_repository:new M,fetch:function(){try{var r=e();return Promise.resolve(r._repository.get()).then(function(e){t(g({},e,{lastFetchedAt:Date.now()}))})}catch(t){return Promise.reject(t)}}}}),I=/*#__PURE__*/function(t){var e,r;function n(e){return void 0===e&&(e="/notifications"),t.call(this,e)||this}r=t,(e=n).prototype=Object.create(r.prototype),e.prototype.constructor=e,S(e,r);var o=n.prototype;return o.markAsRead=function(t){return L(this.remotePathOrUrl+"/"+t+"/read").then(function(){return!0}).catch(function(){return!1})},o.markAsUnread=function(t){return L(this.remotePathOrUrl+"/"+t+"/unread").then(function(){return!0}).catch(function(){return!1})},o.markAllAsSeen=function(){return L(this.remotePathOrUrl+"/seen").then(function(){return!0}).catch(function(){return!1})},o.markAllAsRead=function(){return L(this.remotePathOrUrl+"/read").then(function(){return!0}).catch(function(){return!1})},n}(/*#__PURE__*/function(){function t(t){this.remotePathOrUrl=void 0,this.remotePathOrUrl=t}var e=t.prototype;return e.get=function(t){try{return Promise.resolve(C(this.remotePathOrUrl+"/"+t)).then(function(t){return i.camelizeKeys(t)})}catch(t){return Promise.reject(t)}},e.findBy=function(t){try{var e=this;return Promise.resolve(function(r,n){try{var o=Promise.resolve(C(e.remotePathOrUrl,t)).then(function(t){return i.camelizeKeys(t)})}catch(t){return n(t)}return o&&o.then?o.then(void 0,n):o}(0,function(t){if(!/Network Error/.test(t.message))throw t}))}catch(t){return Promise.reject(t)}},e.delete=function(t){return _(this.remotePathOrUrl+"/"+t).then(function(){return!0}).catch(function(){return!1})},t}()),N=h(),D=h();function F(t,e,r){"remote"===r&&N.emit(t,e),D.emit(t,{data:e,source:r})}function K(t){var e=w.getState().clientId,r=t.name.replace(/\//gi,"."),n=t.data;return n.client_id&&n.client_id===e?Promise.resolve(!1):"string"==typeof n.id?"notifications.delete"===r?(F(r,n,"remote"),Promise.resolve(!0)):(new I).get(n.id).then(function(t){return F(r,t.notification,"remote"),!0}):(F(r,n,"remote"),Promise.resolve(!0))}function z(t){return u({context:{},total:0,totalPages:0,perPage:0,currentPage:1,unreadCount:0,unseenCount:0,notifications:[]},t)}var B=["notifications"];function G(t,e){return t===e||t!=t&&e!=e}function X(t,e,r){void 0===r&&(r=G);var n=[];return Object.keys(e).forEach(function(o){var i,a=e[o];("read"===o&&!r(!f(t.readAt),a)||"seen"===o&&!r(!f(t.seenAt),a)||"categories"===o&&(i=a,Array.isArray(i)?i:[i]).some(function(e){return!r(t.category,e)})||Object.hasOwnProperty.call(t,o)&&!r(t[o],a))&&n.push(o)}),{result:0===n.length,delta:n}}var T=o(function(t,e){return{stores:{},_repository:new I,setStore:function(e,r,n){void 0===r&&(r={}),void 0===n&&(n={}),t(s(function(t){t.stores[e]=z(g({},n,{context:r}))}))},fetchStore:function(r,n,o){void 0===n&&(n={}),void 0===o&&(o={});try{var i=e(),a=i._repository,u=i.stores[r];return Promise.resolve(function(){if(u)return Promise.resolve(a.findBy(g({},u.context,n))).then(function(e){e&&t(s(function(t){t.stores[r]=function(t,e,r){void 0===r&&(r={reset:!1});var n=e.notifications,o=k(e,B),i=r.reset?n:c(function(t){return t.id},r.prepend?[].concat(n,t.notifications):[].concat(t.notifications,n));return g({context:t.context,notifications:i},o)}(u,g({},e,{lastFetchedAt:new Date}),o)}))});console.error("Store not found. Define a store with the "+r+" ID")}())}catch(t){return Promise.reject(t)}},fetchAllStores:function(t,r){void 0===t&&(t={}),void 0===r&&(r={});try{var n=e(),o=n.fetchStore,i=Object.keys(n.stores).map(function(e){return o(e,t,r)});return Promise.resolve(Promise.all(i)).then(function(){})}catch(t){return Promise.reject(t)}},markNotificationAsSeen:function(r){var n=e().stores,o=r.id;F("notifications.seen",r,"local"),t(s(function(t){for(var e in n){var r=n[e],i=r.notifications,a=r.unseenCount,s=l(d("id",o),i);s>-1&&(i[s].seenAt||(t.stores[e].unseenCount=Math.max(0,a-1),t.stores[e].notifications[s]=u(i[s],{seenAt:Date.now()/1e3})))}}))},markNotificationAsRead:function(r){var n=e(),o=n.stores,i=r.id,a=n._repository.markAsRead(i);return F("notifications.read",r,"local"),t(s(function(t){var e={readAt:Date.now()/1e3};for(var n in o){var a=o[n],s=a.total,c=a.notifications,f=a.unreadCount,m=a.context,v=l(d("id",i),c);if(v>-1){t.stores[n].unreadCount=Math.max(0,f-1);var h=u(c[v],e);X(h,m).result?t.stores[n].notifications[v]=h:(t.stores[n].total=Math.max(0,s-1),t.stores[n].notifications.splice(v,1))}else{var p=u(r,e);X(p,m).result&&(t.stores[n].total+=1,t.stores[n].notifications.push(p))}}})),a},markNotificationAsUnread:function(r){var n=e(),o=n.stores,i=r.id,a=n._repository.markAsUnread(i);return F("notifications.unread",r,"local"),t(s(function(t){var e={readAt:null};for(var n in o){var a=o[n],s=a.total,c=a.notifications,f=a.context,m=l(d("id",i),c);if(m>-1){var v=u(c[m],e);X(v,f).result?(t.stores[n].unreadCount+=1,t.stores[n].notifications[m]=v):(t.stores[n].total-=Math.max(0,s-1),t.stores[n].notifications.splice(m,1))}else{var h=u(r,e);X(h,f).result&&(t.stores[n].total+=1,t.stores[n].unreadCount+=1,t.stores[n].notifications.push(h))}}})),a},deleteNotification:function(r,n){void 0===n&&(n={});var o=e(),i=o.stores,a=o._repository,u=r.id,c=Promise.resolve(!0);return!1!==n.persist&&(c=a.delete(u),F("notifications.delete",r,"local")),t(s(function(t){for(var e in i){var r=i[e],n=r.notifications,o=r.total,a=r.unseenCount,s=r.unreadCount,c=l(d("id",u),n);if(c>-1){var f=n[c];f.seenAt||(t.stores[e].unseenCount=Math.max(0,a-1)),f.readAt||(t.stores[e].unreadCount=Math.max(0,s-1)),t.stores[e].total=Math.max(0,o-1),t.stores[e].notifications.splice(c,1)}}})),c},markAllAsSeen:function(r){void 0===r&&(r={persist:!0,updateModels:!0});var n=e(),o=n.stores,i=n._repository,a=Promise.resolve(!0);return!1!==r.persist&&(a=i.markAllAsSeen(),F("notifications.seen.all",null,"local")),t(s(function(t){var e=function(e){var n=o[e].notifications;t.stores[e].unseenCount=0,!1!==r.updateModels&&n.forEach(function(r,n){t.stores[e].notifications[n]=u(r,{seenAt:Date.now()/1e3})})};for(var n in o)e(n)})),a},markAllAsRead:function(r){void 0===r&&(r={persist:!0,updateModels:!0});var n=e(),o=n.stores,i=n._repository,a=Promise.resolve(!0);return!1!==r.persist&&(a=i.markAllAsRead(),F("notifications.read.all",null,"local")),t(s(function(t){var e=function(e){var n=o[e].notifications;t.stores[e].unreadCount=0,!1!==r.updateModels&&n.forEach(function(r,n){t.stores[e].notifications[n]=u(r,{readAt:Date.now()/1e3})})};for(var n in o)e(n)})),a}}});function H(t,r,n){void 0===n&&(n={source:"any"}),e(function(){var e=function(t){void 0===t&&(t={}),"remote"===n.source&&"remote"!==t.source||"local"===n.source&&"local"!==t.source||r(t.data,t.source)};return D.on(t,e),function(){D.off(t,e)}},[])}function J(){var t,r=T(),n=function(){return r.fetchAllStores({page:1},{reset:!0})};return t=j(),e(function(){return t.ws?function(t){var e=t.channel,r=function(t){var e=w.getState().serverURL+"/"+t.authUrl,r=x();return new v.Realtime({authUrl:e,authHeaders:r,authMethod:"POST",log:{level:0},transports:["web_socket"]})}(t),n=function(){return F("wakeup",null,"local")};r.connection.on("disconnected",n),r.connection.on("suspended",n);var o=r.channels.get(e);return o.subscribe(K),function(){o.unsubscribe(K),o.detach(),r.connection.off("disconnected"),r.connection.off("suspended"),r.close()}}(t.ws):function(){}},[t.ws]),H("wakeup",n),H("notifications.new",function(){return r.fetchAllStores({page:1},{prepend:!0})},{source:"remote"}),H("notifications.seen.all",function(){return r.markAllAsSeen({persist:!1})},{source:"remote"}),H("notifications.read.all",function(){return r.markAllAsRead({persist:!1})},{source:"remote"}),H("notifications.read",n,{source:"remote"}),H("notifications.unread",n,{source:"remote"}),H("notifications.delete",function(t){return r.deleteNotification(t,{persist:!1})},{source:"remote"}),null}var Q=["serverURL"],Y=["children","stores","disableRealtime"];function q(t){var e=t.serverURL,r=k(t,Q);return e&&(r.serverURL=e),w.setState(r),r}function V(n){var o=n.children,i=n.stores,a=void 0===i?[{id:"default",defaultQueryParams:{}}]:i,s=n.disableRealtime,u=k(n,Y);r(function(){return q(u)}),r(function(){return function(t){var e={};return t.forEach(function(t){var r=t.defaults;e[t.id]=z(g({context:t.defaultQueryParams},void 0===r?{}:r))}),T.setState({stores:e}),e}(a)});var c=j();return e(function(){c.lastFetchedAt||c.fetch()},[c]),t.createElement(t.Fragment,null,s?null:t.createElement(J,null),o)}function W(t){void 0===t&&(t="default");var r=T(),n=r.stores,o=r.fetchStore,i=r.markAllAsSeen,a=r.markAllAsRead,s=j(),u=n[t],c=function(e,r){return o(t,e,r)};return e(function(){u&&s.lastFetchedAt&&!u.lastFetchedAt&&c({page:1})},[s.lastFetchedAt]),u?g({},u,{isEmpty:0===u.notifications.length,hasNextPage:u.currentPage<u.totalPages,fetch:c,fetchNextPage:function(e,r){return void 0===e&&(e={}),o(t,g({},e,{page:u.currentPage+1}),r)},markAllAsSeen:i,markAllAsRead:a}):null}function Z(t){var e=W((void 0===t?{}:t).storeId);return e?g({},e,{markAllAsSeen:function(){return e&&e.unseenCount>0?null==e?void 0:e.markAllAsSeen({updateModels:!1}):Promise.resolve(!0)}}):null}function $(t){return t?tt(1e3*t):null}function tt(t){return p(t)}function et(t){return p(t).unix()}function rt(t){if(f(t))return null;if("string"==typeof t)try{return JSON.parse(t)}catch(t){console.warn('"customAttributes" is not valid JSON')}return t}function nt(t){var e=T(),r=e.markNotificationAsRead,n=e.markNotificationAsSeen,o=e.markNotificationAsUnread,i=e.deleteNotification;return g({},t,{customAttributes:rt(t.customAttributes),readAt:$(t.readAt),seenAt:$(t.seenAt),sentAt:$(t.sentAt),archivedAt:$(t.archivedAt),isSeen:!f(t.seenAt),isRead:!f(t.readAt),isArchived:!f(t.archivedAt),sanitizedContent:t.content,markAsSeen:function(){return n(t)},markAsRead:function(){return r(t)},markAsUnread:function(){return o(t)},delete:function(){return i(t)}})}function ot(t,r){e(function(){return function(){r?r(t):t.markAsSeen()}},[])}function it(t,e){var r=nt(t);return ot(r,e),r}p.extend(A),p.extend(y),p.extend(P);var at=/*#__PURE__*/function(){function t(t){void 0===t&&(t="/notification_preferences"),this.remotePathOrUrl=void 0,this.remotePathOrUrl=t}var e=t.prototype;return e.get=function(){try{return Promise.resolve(C(this.remotePathOrUrl)).then(function(t){return i.camelizeKeys(t)})}catch(t){return Promise.reject(t)}},e.update=function(t){return b(this.remotePathOrUrl,i.decamelizeKeys(t)).then(function(){return!0}).catch(function(){return!1})},t}(),st=o(function(t,e){return{categories:{},_repository:new at,fetch:function(){try{var r=e();return Promise.resolve(r._repository.get()).then(function(e){t(g({},e.notificationPreferences,{lastFetchedAt:Date.now()}))})}catch(t){return Promise.reject(t)}},save:function(r){try{var n=e(),o=n.categories;return n._repository.update({notificationPreferences:r}),t({categories:m(o,r.categories),lastFetchedAt:Date.now()}),Promise.resolve()}catch(t){return Promise.reject(t)}}}});export{V as MagicBellProvider,J as RealtimeListener,z as buildStore,w as clientSettings,_ as deleteAPI,D as eventAggregator,C as fetchAPI,L as postAPI,N as pushEventAggregator,b as putAPI,E as registry,$ as secondsToDate,tt as toDate,et as toUnix,Z as useBell,j as useConfig,H as useMagicBellEvent,it as useNotification,nt as useNotificationFactory,st as useNotificationPreferences,T as useNotificationStoresCollection,ot as useNotificationUnmount,W as useNotifications};
//# sourceMappingURL=magicbell-react-headless.esm.js.map
